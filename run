#!/bin/bash
# run - Main entry point for ZKVM testing

set -e

CMD=${1:-help}
shift || true

case "$CMD" in
    build)
        echo "🔨 Building ZKVMs: ${@:-all}"
        ./scripts/build.sh "$@"
        ;;
    
    test)
        echo "🧪 Testing ZKVMs: ${@:-all}"
        ./scripts/test.sh "$@"
        python3 scripts/update.py
        ;;
    
    update)
        echo "📊 Updating dashboard"
        python3 scripts/update.py
        ;;
    
    all)
        echo "🚀 Building and testing: ${@:-all}"
        ./scripts/build.sh "$@"
        ./scripts/test.sh "$@"
        python3 scripts/update.py
        ;;
    
    serve)
        echo "🌐 Server at http://localhost:8000"
        echo "   Press Ctrl+C to stop"
        cd docs && python3 -m http.server 8000
        ;;
    
    clean)
        echo "🧹 Cleaning artifacts"
        rm -rf binaries/ test-results/*/
        ;;
    
    deploy)
        echo "🚀 Deploying dashboard to GitHub Pages"
        python3 scripts/update.py
        git add docs/ data/results.json
        git commit -m "Update dashboard: $(date -u +%Y-%m-%d_%H:%M:%S)" || echo "No changes to commit"
        git push
        echo "✅ Deployment triggered. Check: https://codygunton.github.io/zkevm-test-monitor/"
        ;;
    
    *)
        cat << EOF
Usage: ./run COMMAND [TARGETS]

Commands:
  build [zkvm]  - Build ZKVM binaries
  test [zkvm]   - Run RISCOF tests  
  update        - Regenerate dashboard HTML
  all [zkvm]    - Build + test + update
  serve         - Start local web server
  deploy        - Update and push dashboard to GitHub Pages
  clean         - Remove build artifacts

Examples:
  ./run build sp1        # Build just SP1
  ./run test sp1 jolt    # Test SP1 and Jolt
  ./run all              # Build and test everything
  ./run deploy           # Deploy dashboard to GitHub Pages
EOF
        ;;
esac